From 2d86a7a504e7beef19a09d3faa98f1b609a2c092 Mon Sep 17 00:00:00 2001
From: "qmai@libertyglobal.com" <qmai@libertyglobal.com>
Date: Thu, 22 Apr 2021 20:37:44 +0000
Subject: [PATCH] send Renew after T1 timer expires ( OFW 1143 )

Previously the DHCPv6 client would send a Solicit message after the
T1 timer expires. Send a Renew instead.

v2
---
 ClntMessages/ClntMsgRequest.cpp | 11 +++++++++--
 ClntMessages/ClntMsgSolicit.cpp |  7 +++++++
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/ClntMessages/ClntMsgRequest.cpp b/ClntMessages/ClntMsgRequest.cpp
index db9ac40c..5d30e099 100644
--- a/ClntMessages/ClntMsgRequest.cpp
+++ b/ClntMessages/ClntMsgRequest.cpp
@@ -62,8 +62,9 @@ TClntMsgRequest::TClntMsgRequest(TOptList opts, int iface)
     SPtr<TClntMsg> advertise = SPtr_cast<TClntMsg>(ClntTransMgr().getAdvertise());
     copyAAASPI(SPtr_cast<TClntMsg>(advertise));
 
-    // remove just used server
-    ClntTransMgr().delFirstAdvertise();
+    // There will be no server available for REQUEST.
+    // remove just used server later.
+    // ClntTransMgr().delFirstAdvertise();
 
     // copy whole list from SOLICIT ...
     Options = opts;
@@ -209,6 +210,12 @@ void TClntMsgRequest::doDuties()
     // timeout is reached and we still don't have answer, retransmit
     if (RC>MRC) 
     {
+        // remove all used servers from the list
+        while (ClntTransMgr().getAdvertiseLstCount())
+        {
+            ClntTransMgr().delFirstAdvertise();
+        }
+
         ClntTransMgr().sendRequest(Options, Iface);
 
         IsDone = true;
diff --git a/ClntMessages/ClntMsgSolicit.cpp b/ClntMessages/ClntMsgSolicit.cpp
index 6ace86e8..9f77f293 100644
--- a/ClntMessages/ClntMsgSolicit.cpp
+++ b/ClntMessages/ClntMsgSolicit.cpp
@@ -112,6 +112,13 @@ TClntMsgSolicit::TClntMsgSolicit(int iface, SPtr<TIPv6Addr> addr,
     appendAuthenticationOption();
     
     IsDone = false;
+
+    // remove all used servers from the list
+    while (ClntTransMgr().getAdvertiseLstCount())
+    {
+        ClntTransMgr().delFirstAdvertise();
+    }
+
     send();
 }
 
-- 
2.24.0

